<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NSFW.VAULT | Secure Access</title>
    <style>
        :root { --main-color: #00ff00; --bg-color: #050505; }
        body { background: var(--bg-color); color: var(--main-color); font-family: 'Courier New', monospace; text-align: center; padding-top: 20vh; margin: 0; }
        .header { font-size: 3rem; font-weight: bold; text-transform: uppercase; letter-spacing: 10px; margin-bottom: 30px; }
        .vault-container { border: 2px solid var(--main-color); display: inline-block; padding: 60px; box-shadow: 0 0 30px rgba(0, 255, 0, 0.2); }
        #key-display { font-size: 2.5rem; font-weight: bold; }
        #status-msg { margin-top: 20px; font-size: 0.9rem; color: #888; }
    </style>
</head>
<body>

    <div class="header">NSFW.VAULT</div>

    <div class="vault-container">
        <div id="key-display">VERIFYING IP...</div>
    </div>

    <p id="status-msg">Performing security handshake...</p>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBLLWB60iLX9SE6zCWHKYCvdzP51-fZEo8",
            databaseURL: "https://keysystem-b5fa5-default-rtdb.firebaseio.com/",
            projectId: "keysystem-b5fa5",
            appId: "1:898842570370:web:6987aeb9e3e50168e20e9b"
        };

        document.addEventListener('DOMContentLoaded', async () => {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            const display = document.getElementById('key-display');
            const status = document.getElementById('status-msg');

            async function securePull() {
                try {
                    // 1. Get the user's public IP address
                    const ipResponse = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipResponse.json();
                    const userIP = ipData.ip.replace(/\./g, '_'); // Firebase doesn't like dots in keys
                    const now = Date.now();

                    // 2. Check Database for this IP
                    const ipRef = db.ref(`vault/user_ips/${userIP}`);
                    const ipSnapshot = await ipRef.once('value');
                    
                    if (ipSnapshot.exists()) {
                        const lastClaim = ipSnapshot.val().time;
                        const waitTime = 1 * 60 * 60 * 1000; // 1 Hour in ms

                        if (now - lastClaim < waitTime) {
                            display.innerText = "ACCESS DENIED";
                            status.innerText = "IP Locked. One key per hour allowed.";
                            return;
                        }
                    }

                    // 3. If clear, pull new key
                    const availRef = db.ref('vault/available_keys');
                    const pendingRef = db.ref('vault/pending_redemption');
                    const keySnapshot = await availRef.limitToFirst(1).once('value');

                    if (keySnapshot.exists()) {
                        const id = Object.keys(keySnapshot.val())[0];
                        const code = keySnapshot.val()[id].code;

                        // 4. Update IP log and Purge key
                        await ipRef.set({ time: now, code: code });
                        await pendingRef.push({ code: code, claimed_at: now, ip: userIP });
                        await availRef.child(id).remove();

                        display.innerText = code;
                        status.innerText = "New key issued. Your IP is logged for 1 hour.";
                    } else {
                        display.innerText = "VAULT EMPTY";
                        status.innerText = "Request admin refill in Discord.";
                    }

                } catch (err) {
                    display.innerText = "ERROR";
                    status.innerText = "Security check failed: " + err.message;
                }
            }

            securePull();
        });
    </script>
</body>
</html>
